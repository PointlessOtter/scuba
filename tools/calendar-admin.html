<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScubaLife - KalendÄra PÄrvaldÄ«ba</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #1a3a5c; border-bottom: 3px solid #1a3a5c; padding-bottom: 10px; }
        h2 { color: #1a3a5c; margin-top: 30px; }
        
        .config-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config-section label { font-weight: bold; }
        .config-section input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
        }
        .config-section .hint { font-size: 12px; color: #666; margin-top: 5px; }
        
        .status {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .status.success { background: #d4edda; color: #155724; display: block; }
        .status.error { background: #f8d7da; color: #721c24; display: block; }
        .status.loading { background: #cce5ff; color: #004085; display: block; }
        
        .events-list { display: grid; gap: 15px; }
        .event-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 15px;
            align-items: center;
        }
        .event-card.inactive { opacity: 0.5; background: #f9f9f9; }
        .event-card img {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            background: #eee;
        }
        .event-info h3 { margin: 0 0 5px 0; color: #1a3a5c; }
        .event-info .dates { color: #666; font-size: 14px; }
        .event-info .document { font-size: 12px; color: #007bff; }
        .event-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .event-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-edit { background: #007bff; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-toggle { background: #6c757d; color: white; }
        .btn-edit:hover { background: #0056b3; }
        .btn-delete:hover { background: #c82333; }
        .btn-toggle:hover { background: #545b62; }
        
        .form-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-weight: bold; margin-bottom: 5px; color: #333; }
        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group input[type="file"] { padding: 8px; background: #f8f9fa; }
        .file-preview { margin-top: 10px; font-size: 12px; color: #666; }
        .file-preview img {
            max-width: 200px;
            max-height: 100px;
            display: block;
            margin-top: 5px;
            border-radius: 4px;
        }
        
        .btn-primary {
            background: #1a3a5c;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-primary:hover { background: #0d2137; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-content h2 { margin-top: 0; }
        
        @media (max-width: 768px) {
            .event-card { grid-template-columns: 1fr; text-align: center; }
            .event-card img { margin: 0 auto; }
            .event-actions { justify-content: center; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <h1>ğŸ¤¿ ScubaLife - KalendÄra PÄrvaldÄ«ba</h1>
    
    <!-- GitHub Configuration -->
    <div class="config-section">
        <label>GitHub Token (Fine-grained, tikai Å¡im repo):</label>
        <input type="password" id="github-token" placeholder="github_pat_..." />
        <div class="hint">
            Izveidot: GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens â†’ Fine-grained tokens<br>
            Permissions: Contents (Read and write) | Repository: PointlessOtter/scuba
        </div>
        <button onclick="saveToken()" style="margin-top:10px;padding:8px 15px;cursor:pointer;">ğŸ’¾ SaglabÄt Token</button>
        <button onclick="loadEvents()" style="margin-top:10px;padding:8px 15px;cursor:pointer;margin-left:10px;">ğŸ”„ IelÄdÄ“t PasÄkumus</button>
    </div>
    
    <div id="status" class="status"></div>
    
    <!-- Add New Event -->
    <h2>â• Pievienot jaunu pasÄkumu</h2>
    <div class="form-section">
        <div class="form-row">
            <div class="form-group full">
                <label>Nosaukums *</label>
                <input type="text" id="new-title" placeholder="piem., NirÅ¡ana MaltÄ" />
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>SÄkuma datums *</label>
                <input type="date" id="new-date-start" />
            </div>
            <div class="form-group">
                <label>Beigu datums *</label>
                <input type="date" id="new-date-end" />
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>AttÄ“ls *</label>
                <input type="file" id="new-image" accept="image/*" onchange="previewFile(this, 'new-image-preview')" />
                <div id="new-image-preview" class="file-preview"></div>
            </div>
            <div class="form-group">
                <label>Dokuments (PDF) - neobligÄts</label>
                <input type="file" id="new-document" accept=".pdf" onchange="previewFile(this, 'new-doc-preview')" />
                <div id="new-doc-preview" class="file-preview"></div>
            </div>
        </div>
        <button class="btn-primary" onclick="addEvent()">â• Pievienot pasÄkumu</button>
    </div>
    
    <!-- Existing Events -->
    <h2>ğŸ“… EsoÅ¡ie pasÄkumi</h2>
    <div id="events-list" class="events-list">
        <p style="color:#666;">Ievadi GitHub token un spied "IelÄdÄ“t PasÄkumus"</p>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2>âœï¸ RediÄ£Ä“t pasÄkumu</h2>
            <input type="hidden" id="edit-index" />
            <div class="form-row">
                <div class="form-group full">
                    <label>Nosaukums *</label>
                    <input type="text" id="edit-title" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>SÄkuma datums *</label>
                    <input type="date" id="edit-date-start" />
                </div>
                <div class="form-group">
                    <label>Beigu datums *</label>
                    <input type="date" id="edit-date-end" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Jauns attÄ“ls (atstÄj tukÅ¡u, lai saglabÄtu esoÅ¡o)</label>
                    <input type="file" id="edit-image" accept="image/*" onchange="previewFile(this, 'edit-image-preview')" />
                    <div id="edit-image-preview" class="file-preview"></div>
                </div>
                <div class="form-group">
                    <label>Jauns dokuments (atstÄj tukÅ¡u, lai saglabÄtu esoÅ¡o)</label>
                    <input type="file" id="edit-document" accept=".pdf" onchange="previewFile(this, 'edit-doc-preview')" />
                    <div id="edit-doc-preview" class="file-preview"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>AktÄ«vs</label>
                    <select id="edit-active">
                        <option value="true">JÄ - rÄdÄ«t kalendÄrÄ</option>
                        <option value="false">NÄ“ - paslÄ“pt</option>
                    </select>
                </div>
            </div>
            <button class="btn-primary" onclick="saveEdit()">ğŸ’¾ SaglabÄt izmaiÅ†as</button>
            <button class="btn-secondary" onclick="closeModal()">âŒ Atcelt</button>
        </div>
    </div>

    <script>
        // Configuration
        const REPO_OWNER = 'PointlessOtter';
        const REPO_NAME = 'scuba';
        const EVENTS_FILE_PATH = 'js/events-data.js';
        const BRANCH = 'master';
        
        let eventsData = [];
        let currentFileSha = '';
        
        // Token management
        function saveToken() {
            const token = document.getElementById('github-token').value.trim();
            if (token) {
                localStorage.setItem('github_token_scuba', token);
                showStatus('Token saglabÄts!', 'success');
            }
        }
        
        function getToken() {
            const input = document.getElementById('github-token');
            return input.value.trim() || localStorage.getItem('github_token_scuba') || '';
        }
        
        // Load token on page load
        window.onload = function() {
            const savedToken = localStorage.getItem('github_token_scuba');
            if (savedToken) {
                document.getElementById('github-token').value = savedToken;
                loadEvents();
            }
        };
        
        // Status messages
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            if (type === 'success') {
                setTimeout(() => { status.className = 'status'; }, 3000);
            }
        }
        
        // File preview
        function previewFile(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        preview.innerHTML = `<img src="${e.target.result}" alt="Preview" />`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.textContent = `ğŸ“„ ${file.name}`;
                }
            } else {
                preview.innerHTML = '';
            }
        }
        
        // GitHub API calls
        async function githubRequest(endpoint, options = {}) {
            const token = getToken();
            if (!token) {
                throw new Error('Nav ievadÄ«ts GitHub token!');
            }
            
            const response = await fetch(`https://api.github.com${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `GitHub API kÄ¼Å«da: ${response.status}`);
            }
            
            return response.json();
        }
        
        // Load events from GitHub
        async function loadEvents() {
            try {
                showStatus('IelÄdÄ“ pasÄkumus...', 'loading');
                
                const file = await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${EVENTS_FILE_PATH}?ref=${BRANCH}`);
                currentFileSha = file.sha;
                
                // Properly decode UTF-8 from base64
                const bytes = Uint8Array.from(atob(file.content), c => c.charCodeAt(0));
                const content = new TextDecoder('utf-8').decode(bytes);
                // Extract the array from the JS file
                const match = content.match(/window\.SCUBA_EVENTS\s*=\s*(\[[\s\S]*\]);/);
                if (match) {
                    // Remove comments before parsing
                    const jsonStr = match[1].replace(/\/\/.*$/gm, '');
                    eventsData = eval(jsonStr);
                }
                
                renderEvents();
                showStatus('PasÄkumi ielÄdÄ“ti! (' + eventsData.length + ' pasÄkumi)', 'success');
            } catch (error) {
                showStatus('KÄ¼Å«da: ' + error.message, 'error');
            }
        }
        
        // Render events list
        function renderEvents() {
            const container = document.getElementById('events-list');
            
            if (eventsData.length === 0) {
                container.innerHTML = '<p style="color:#666;">Nav pasÄkumu</p>';
                return;
            }
            
            // Sort by date (newest first)
            const sorted = [...eventsData].map((e, i) => ({...e, originalIndex: i}))
                .sort((a, b) => new Date(b.dateStart) - new Date(a.dateStart));
            
            container.innerHTML = sorted.map(event => `
                <div class="event-card ${event.active ? '' : 'inactive'}">
                    <img src="https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${event.image}" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ–¼ï¸</text></svg>'" 
                         alt="${event.title}" />
                    <div class="event-info">
                        <h3>${event.title}</h3>
                        <div class="dates">ğŸ“… ${formatDate(event.dateStart)} - ${formatDate(event.dateEnd)}</div>
                        ${event.documentUrl ? `<div class="document">ğŸ“„ ${event.documentUrl.split('/').pop()}</div>` : '<div class="document" style="color:#999;">Nav dokumenta</div>'}
                        ${!event.active ? '<div style="color:orange;font-size:12px;margin-top:5px;">âš ï¸ PaslÄ“pts - nerÄdÄs kalendÄrÄ</div>' : ''}
                    </div>
                    <div class="event-actions">
                        <button class="btn-edit" onclick="openEditModal(${event.originalIndex})">âœï¸ RediÄ£Ä“t</button>
                        <button class="btn-toggle" onclick="toggleEvent(${event.originalIndex})">${event.active ? 'ğŸ‘ï¸ PaslÄ“pt' : 'ğŸ‘ï¸ RÄdÄ«t'}</button>
                        <button class="btn-delete" onclick="deleteEvent(${event.originalIndex})">ğŸ—‘ï¸ DzÄ“st</button>
                    </div>
                </div>
            `).join('');
        }
        
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('lv-LV');
        }
        
        // Upload file to GitHub
        async function uploadFile(file, folder) {
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async () => {
                    try {
                        const base64 = reader.result.split(',')[1];
                        const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9._-]/g, '_')}`;
                        const path = `${folder}/${fileName}`;
                        
                        await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                message: `Add ${fileName}`,
                                content: base64,
                                branch: BRANCH
                            })
                        });
                        
                        resolve(path);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Save events to GitHub
        async function saveEvents(commitMessage) {
            const content = `/**
 * SCUBALIFE Events Data
 * 
 * TO ADD A NEW EVENT:
 * 1. Copy any event block below
 * 2. Paste it and update the fields
 * 3. Save and commit
 * 
 * FIELDS:
 * - title: Event name (shown as heading)
 * - dateStart: Start date in YYYY-MM-DD format
 * - dateEnd: End date in YYYY-MM-DD format  
 * - image: Path to event image
 * - documentUrl: Link to PDF or webpage (set to null if none)
 * - active: Set to false to hide without deleting
 */

window.SCUBA_EVENTS = ${JSON.stringify(eventsData, null, 4)};
`;
            
            const result = await githubRequest(`/repos/${REPO_OWNER}/${REPO_NAME}/contents/${EVENTS_FILE_PATH}`, {
                method: 'PUT',
                body: JSON.stringify({
                    message: commitMessage,
                    content: btoa(unescape(encodeURIComponent(content))),
                    sha: currentFileSha,
                    branch: BRANCH
                })
            });
            
            currentFileSha = result.content.sha;
        }
        
        // Add new event
        async function addEvent() {
            try {
                const title = document.getElementById('new-title').value.trim();
                const dateStart = document.getElementById('new-date-start').value;
                const dateEnd = document.getElementById('new-date-end').value;
                const imageFile = document.getElementById('new-image').files[0];
                const docFile = document.getElementById('new-document').files[0];
                
                if (!title || !dateStart || !dateEnd || !imageFile) {
                    showStatus('Aizpildi visus obligÄtos laukus (nosaukums, datumi, attÄ“ls)!', 'error');
                    return;
                }
                
                showStatus('AugÅ¡upielÄdÄ“ attÄ“lu...', 'loading');
                
                // Upload image
                const imagePath = await uploadFile(imageFile, 'assets/images/events');
                
                // Upload document if provided
                let docPath = null;
                if (docFile) {
                    showStatus('AugÅ¡upielÄdÄ“ dokumentu...', 'loading');
                    docPath = await uploadFile(docFile, 'assets/documents');
                }
                
                // Add to events
                eventsData.unshift({
                    title: title,
                    dateStart: dateStart,
                    dateEnd: dateEnd,
                    image: imagePath,
                    documentUrl: docPath,
                    active: true
                });
                
                showStatus('SaglabÄ izmaiÅ†as GitHub...', 'loading');
                await saveEvents(`Add event: ${title}`);
                
                // Clear form
                document.getElementById('new-title').value = '';
                document.getElementById('new-date-start').value = '';
                document.getElementById('new-date-end').value = '';
                document.getElementById('new-image').value = '';
                document.getElementById('new-document').value = '';
                document.getElementById('new-image-preview').innerHTML = '';
                document.getElementById('new-doc-preview').innerHTML = '';
                
                renderEvents();
                showStatus('âœ… PasÄkums pievienots! MÄjaslapa atjaunosies ~1 minÅ«tes laikÄ.', 'success');
                
            } catch (error) {
                showStatus('KÄ¼Å«da: ' + error.message, 'error');
            }
        }
        
        // Open edit modal
        function openEditModal(index) {
            const event = eventsData[index];
            document.getElementById('edit-index').value = index;
            document.getElementById('edit-title').value = event.title;
            document.getElementById('edit-date-start').value = event.dateStart;
            document.getElementById('edit-date-end').value = event.dateEnd;
            document.getElementById('edit-active').value = event.active.toString();
            document.getElementById('edit-image').value = '';
            document.getElementById('edit-document').value = '';
            document.getElementById('edit-image-preview').innerHTML = `<span>PaÅ¡reizÄ“jais:</span><img src="https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${event.image}" alt="Current" />`;
            document.getElementById('edit-doc-preview').textContent = event.documentUrl ? `PaÅ¡reizÄ“jais: ğŸ“„ ${event.documentUrl.split('/').pop()}` : 'Nav dokumenta';
            
            document.getElementById('edit-modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }
        
        // Save edit
        async function saveEdit() {
            try {
                const index = parseInt(document.getElementById('edit-index').value);
                const title = document.getElementById('edit-title').value.trim();
                const dateStart = document.getElementById('edit-date-start').value;
                const dateEnd = document.getElementById('edit-date-end').value;
                const active = document.getElementById('edit-active').value === 'true';
                const imageFile = document.getElementById('edit-image').files[0];
                const docFile = document.getElementById('edit-document').files[0];
                
                if (!title || !dateStart || !dateEnd) {
                    showStatus('Aizpildi visus obligÄtos laukus!', 'error');
                    return;
                }
                
                showStatus('SaglabÄ izmaiÅ†as...', 'loading');
                
                // Upload new image if provided
                let imagePath = eventsData[index].image;
                if (imageFile) {
                    showStatus('AugÅ¡upielÄdÄ“ jaunu attÄ“lu...', 'loading');
                    imagePath = await uploadFile(imageFile, 'assets/images/events');
                }
                
                // Upload new document if provided
                let docPath = eventsData[index].documentUrl;
                if (docFile) {
                    showStatus('AugÅ¡upielÄdÄ“ jaunu dokumentu...', 'loading');
                    docPath = await uploadFile(docFile, 'assets/documents');
                }
                
                // Update event
                eventsData[index] = {
                    title: title,
                    dateStart: dateStart,
                    dateEnd: dateEnd,
                    image: imagePath,
                    documentUrl: docPath,
                    active: active
                };
                
                showStatus('SaglabÄ GitHub...', 'loading');
                await saveEvents(`Update event: ${title}`);
                
                closeModal();
                renderEvents();
                showStatus('âœ… IzmaiÅ†as saglabÄtas! MÄjaslapa atjaunosies ~1 minÅ«tes laikÄ.', 'success');
                
            } catch (error) {
                showStatus('KÄ¼Å«da: ' + error.message, 'error');
            }
        }
        
        // Toggle event visibility
        async function toggleEvent(index) {
            try {
                eventsData[index].active = !eventsData[index].active;
                const action = eventsData[index].active ? 'Show' : 'Hide';
                showStatus('SaglabÄ izmaiÅ†as...', 'loading');
                await saveEvents(`${action} event: ${eventsData[index].title}`);
                renderEvents();
                showStatus('âœ… IzmaiÅ†as saglabÄtas!', 'success');
            } catch (error) {
                eventsData[index].active = !eventsData[index].active; // Revert
                showStatus('KÄ¼Å«da: ' + error.message, 'error');
            }
        }
        
        // Delete event
        async function deleteEvent(index) {
            if (!confirm(`Vai tieÅ¡Äm dzÄ“st "${eventsData[index].title}"?\n\nÅ o darbÄ«bu nevar atcelt!`)) {
                return;
            }
            
            try {
                const title = eventsData[index].title;
                eventsData.splice(index, 1);
                showStatus('DzÄ“Å¡ pasÄkumu...', 'loading');
                await saveEvents(`Delete event: ${title}`);
                renderEvents();
                showStatus('âœ… PasÄkums dzÄ“sts!', 'success');
            } catch (error) {
                showStatus('KÄ¼Å«da: ' + error.message, 'error');
                loadEvents(); // Reload to restore state
            }
        }
        
        // Close modal on outside click
        document.getElementById('edit-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
